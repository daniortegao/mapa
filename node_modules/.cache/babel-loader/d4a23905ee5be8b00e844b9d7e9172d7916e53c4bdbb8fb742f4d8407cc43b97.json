{"ast":null,"code":"var _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\nimport { useMap } from 'react-leaflet';\nimport L from 'leaflet';\nimport { createCustomIcon, createBrandLogo } from '../utils/iconHelpers';\nconst IconMarkersLayer = ({\n  markers,\n  selectedRegion,\n  baseCompData = []\n}) => {\n  _s();\n  const map = useMap();\n  const markersRef = useRef({});\n  const cacheRef = useRef({});\n  const updateInProgressRef = useRef(false);\n  const zoomUpdateRef = useRef(null);\n  const [showingAssociated, setShowingAssociated] = useState(false);\n  const [originalPopupMarker, setOriginalPopupMarker] = useState(null);\n  const [currentEdsFilter, setCurrentEdsFilter] = useState('');\n  const makeDraggable = useCallback(popup => {\n    if (!map || !popup || !popup._container) return;\n    try {\n      const pos = map.latLngToLayerPoint(popup.getLatLng());\n      L.DomUtil.setPosition(popup._wrapper.parentNode, pos);\n      const draggable = new L.Draggable(popup._container, popup._wrapper);\n      draggable.enable();\n    } catch (error) {\n      console.error('Error draggable:', error);\n    }\n  }, [map]);\n  const addMarkers = useCallback((data, mapInstance, edsFilter = '') => {\n    data.forEach(marker => {\n      const lat = parseFloat(marker.lat);\n      const lng = parseFloat(marker.lng);\n      if (!isNaN(lat) && !isNaN(lng)) {\n        const iconUrl = createCustomIcon(marker.Marca);\n        const leafletMarker = L.marker([lat, lng], {\n          icon: iconUrl\n        }).addTo(mapInstance);\n        let popupContent = `\n          <div class=\"popup-content\">\n            <strong>${marker.nombre}</strong><br/>\n            Marca: ${marker.Marca}<br/>\n            EDS: ${marker.eds}<br/>\n            Comuna: ${marker.Comuna}<br/>\n            Región: ${marker.Region}\n            <button class=\"btn-mercado\" data-marker-id=\"${marker.id}\">Ver Mercado</button>\n          </div>\n        `;\n        const popup = L.popup({\n          maxWidth: 300\n        }).setContent(popupContent);\n        leafletMarker.bindPopup(popup);\n        leafletMarker.on('click', () => {\n          mapInstance.setView([lat, lng], mapInstance.getZoom());\n          setTimeout(() => {\n            makeDraggable(popup);\n            const btn = document.querySelector(`[data-marker-id=\"${marker.id}\"]`);\n            if (btn) {\n              btn.addEventListener('click', e => {\n                e.stopPropagation();\n                handleShowMercado(marker);\n              });\n            }\n          }, 100);\n        });\n        markersRef.current[marker.id] = {\n          marker: leafletMarker,\n          data: marker,\n          popup: popup\n        };\n      }\n    });\n  }, [makeDraggable]);\n  const handleShowMercado = useCallback(marker => {\n    // Mostrar mercado del EDS + TODA la competencia en la misma Comuna\n    const markersEnComunaDelEds = markers.filter(m => m.Comuna === marker.Comuna);\n    Object.values(markersRef.current).forEach(markerRef => {\n      markerRef.marker.setOpacity(0.3);\n    });\n    markersEnComunaDelEds.forEach(m => {\n      const key = m.id;\n      if (markersRef.current[key]) {\n        markersRef.current[key].marker.setOpacity(1);\n      }\n    });\n    setShowingAssociated(true);\n    setOriginalPopupMarker(marker);\n    setCurrentEdsFilter(marker.eds);\n    console.log(`Mostrando mercado para: ${marker.nombre} en Comuna: ${marker.Comuna}`);\n    console.log(`Total de estaciones en esta comuna: ${markersEnComunaDelEds.length}`);\n  }, [markers]);\n  const handleBackFromMercado = useCallback(() => {\n    Object.values(markersRef.current).forEach(markerRef => {\n      markerRef.marker.setOpacity(1);\n    });\n    setShowingAssociated(false);\n    setOriginalPopupMarker(null);\n    setCurrentEdsFilter('');\n  }, []);\n  useEffect(() => {\n    if (!map) return;\n    const clearMarkers = () => {\n      Object.values(markersRef.current).forEach(markerRef => {\n        map.removeLayer(markerRef.marker);\n      });\n      markersRef.current = {};\n    };\n    clearMarkers();\n    addMarkers(markers, map, currentEdsFilter);\n    return () => {\n      clearMarkers();\n    };\n  }, [markers, map, addMarkers, currentEdsFilter]);\n  useEffect(() => {\n    const handleBackClick = () => {\n      if (showingAssociated) {\n        handleBackFromMercado();\n      }\n    };\n    document.addEventListener('custom-back-mercado', handleBackClick);\n    return () => {\n      document.removeEventListener('custom-back-mercado', handleBackClick);\n    };\n  }, [showingAssociated, handleBackFromMercado]);\n  return null;\n};\n_s(IconMarkersLayer, \"SxuI5OEsLnql8S8jO7dIyBjZVVk=\", false, function () {\n  return [useMap];\n});\n_c = IconMarkersLayer;\nexport default IconMarkersLayer;\nvar _c;\n$RefreshReg$(_c, \"IconMarkersLayer\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useCallback","useMap","L","createCustomIcon","createBrandLogo","IconMarkersLayer","markers","selectedRegion","baseCompData","_s","map","markersRef","cacheRef","updateInProgressRef","zoomUpdateRef","showingAssociated","setShowingAssociated","originalPopupMarker","setOriginalPopupMarker","currentEdsFilter","setCurrentEdsFilter","makeDraggable","popup","_container","pos","latLngToLayerPoint","getLatLng","DomUtil","setPosition","_wrapper","parentNode","draggable","Draggable","enable","error","console","addMarkers","data","mapInstance","edsFilter","forEach","marker","lat","parseFloat","lng","isNaN","iconUrl","Marca","leafletMarker","icon","addTo","popupContent","nombre","eds","Comuna","Region","id","maxWidth","setContent","bindPopup","on","setView","getZoom","setTimeout","btn","document","querySelector","addEventListener","e","stopPropagation","handleShowMercado","current","markersEnComunaDelEds","filter","m","Object","values","markerRef","setOpacity","key","log","length","handleBackFromMercado","clearMarkers","removeLayer","handleBackClick","removeEventListener","_c","$RefreshReg$"],"sources":["C:/Users/e08f/Desktop/Proyectos/Resumen/mapa-v2/src/components/IconMarkersLayer.jsx"],"sourcesContent":["import React, { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { useMap } from 'react-leaflet';\r\nimport L from 'leaflet';\r\nimport { createCustomIcon, createBrandLogo } from '../utils/iconHelpers';\r\n\r\nconst IconMarkersLayer = ({ markers, selectedRegion, baseCompData = [] }) => {\r\n  const map = useMap();\r\n  const markersRef = useRef({});\r\n  const cacheRef = useRef({});\r\n  const updateInProgressRef = useRef(false);\r\n  const zoomUpdateRef = useRef(null);\r\n  const [showingAssociated, setShowingAssociated] = useState(false);\r\n  const [originalPopupMarker, setOriginalPopupMarker] = useState(null);\r\n  const [currentEdsFilter, setCurrentEdsFilter] = useState('');\r\n\r\n  const makeDraggable = useCallback((popup) => {\r\n    if (!map || !popup || !popup._container) return;\r\n    try {\r\n      const pos = map.latLngToLayerPoint(popup.getLatLng());\r\n      L.DomUtil.setPosition(popup._wrapper.parentNode, pos);\r\n      const draggable = new L.Draggable(popup._container, popup._wrapper);\r\n      draggable.enable();\r\n    } catch (error) {\r\n      console.error('Error draggable:', error);\r\n    }\r\n  }, [map]);\r\n\r\n  const addMarkers = useCallback((data, mapInstance, edsFilter = '') => {\r\n    data.forEach(marker => {\r\n      const lat = parseFloat(marker.lat);\r\n      const lng = parseFloat(marker.lng);\r\n\r\n      if (!isNaN(lat) && !isNaN(lng)) {\r\n        const iconUrl = createCustomIcon(marker.Marca);\r\n        const leafletMarker = L.marker([lat, lng], { icon: iconUrl }).addTo(mapInstance);\r\n\r\n        let popupContent = `\r\n          <div class=\"popup-content\">\r\n            <strong>${marker.nombre}</strong><br/>\r\n            Marca: ${marker.Marca}<br/>\r\n            EDS: ${marker.eds}<br/>\r\n            Comuna: ${marker.Comuna}<br/>\r\n            Región: ${marker.Region}\r\n            <button class=\"btn-mercado\" data-marker-id=\"${marker.id}\">Ver Mercado</button>\r\n          </div>\r\n        `;\r\n\r\n        const popup = L.popup({ maxWidth: 300 }).setContent(popupContent);\r\n        leafletMarker.bindPopup(popup);\r\n\r\n        leafletMarker.on('click', () => {\r\n          mapInstance.setView([lat, lng], mapInstance.getZoom());\r\n          setTimeout(() => {\r\n            makeDraggable(popup);\r\n            const btn = document.querySelector(`[data-marker-id=\"${marker.id}\"]`);\r\n            if (btn) {\r\n              btn.addEventListener('click', (e) => {\r\n                e.stopPropagation();\r\n                handleShowMercado(marker);\r\n              });\r\n            }\r\n          }, 100);\r\n        });\r\n\r\n        markersRef.current[marker.id] = {\r\n          marker: leafletMarker,\r\n          data: marker,\r\n          popup: popup,\r\n        };\r\n      }\r\n    });\r\n  }, [makeDraggable]);\r\n\r\n  const handleShowMercado = useCallback((marker) => {\r\n    // Mostrar mercado del EDS + TODA la competencia en la misma Comuna\r\n    const markersEnComunaDelEds = markers.filter(m => m.Comuna === marker.Comuna);\r\n\r\n    Object.values(markersRef.current).forEach(markerRef => {\r\n      markerRef.marker.setOpacity(0.3);\r\n    });\r\n\r\n    markersEnComunaDelEds.forEach(m => {\r\n      const key = m.id;\r\n      if (markersRef.current[key]) {\r\n        markersRef.current[key].marker.setOpacity(1);\r\n      }\r\n    });\r\n\r\n    setShowingAssociated(true);\r\n    setOriginalPopupMarker(marker);\r\n    setCurrentEdsFilter(marker.eds);\r\n\r\n    console.log(`Mostrando mercado para: ${marker.nombre} en Comuna: ${marker.Comuna}`);\r\n    console.log(`Total de estaciones en esta comuna: ${markersEnComunaDelEds.length}`);\r\n  }, [markers]);\r\n\r\n  const handleBackFromMercado = useCallback(() => {\r\n    Object.values(markersRef.current).forEach(markerRef => {\r\n      markerRef.marker.setOpacity(1);\r\n    });\r\n    setShowingAssociated(false);\r\n    setOriginalPopupMarker(null);\r\n    setCurrentEdsFilter('');\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!map) return;\r\n\r\n    const clearMarkers = () => {\r\n      Object.values(markersRef.current).forEach(markerRef => {\r\n        map.removeLayer(markerRef.marker);\r\n      });\r\n      markersRef.current = {};\r\n    };\r\n\r\n    clearMarkers();\r\n    addMarkers(markers, map, currentEdsFilter);\r\n\r\n    return () => {\r\n      clearMarkers();\r\n    };\r\n  }, [markers, map, addMarkers, currentEdsFilter]);\r\n\r\n  useEffect(() => {\r\n    const handleBackClick = () => {\r\n      if (showingAssociated) {\r\n        handleBackFromMercado();\r\n      }\r\n    };\r\n\r\n    document.addEventListener('custom-back-mercado', handleBackClick);\r\n    return () => {\r\n      document.removeEventListener('custom-back-mercado', handleBackClick);\r\n    };\r\n  }, [showingAssociated, handleBackFromMercado]);\r\n\r\n  return null;\r\n};\r\n\r\nexport default IconMarkersLayer;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}