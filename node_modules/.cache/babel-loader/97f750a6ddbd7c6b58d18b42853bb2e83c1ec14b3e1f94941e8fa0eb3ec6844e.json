{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\e08f\\\\Desktop\\\\Proyectos\\\\Resumen\\\\mapa-v2\\\\src\\\\components\\\\IconMarkersLayer.jsx\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\nimport { useMap } from 'react-leaflet';\nimport L from 'leaflet';\nimport ReactDOM from 'react-dom/client';\nimport { createCustomIcon } from '../utils/iconHelpers';\nimport { guardarCoordenadaCorregida } from '../services/apiService';\nimport MapPopup from './MapPopup';\nimport '../styles/iconMarkersLayer.css';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst IconMarkersLayer = ({\n  markers,\n  markersForMercado = null,\n  selectedRegion,\n  baseCompData = [],\n  nivel2EnNivel1Stations = [],\n  onToggleNivel2EnNivel1\n}) => {\n  _s();\n  var _markers$;\n  const map = useMap();\n  const markersRef = useRef({});\n  const guerraMarkersRef = useRef({});\n  const competenciaMarkersRef = useRef([]);\n  const polylineRef = useRef([]);\n  console.log(' IconMarkersLayer RENDER:', {\n    markersCount: markers === null || markers === void 0 ? void 0 : markers.length,\n    markersRefCount: Object.keys(markersRef.current).length,\n    selectedRegion,\n    firstMarkerComuna: markers === null || markers === void 0 ? void 0 : (_markers$ = markers[0]) === null || _markers$ === void 0 ? void 0 : _markers$.Comuna,\n    uniqueComunas: [...new Set((markers || []).map(m => m.Comuna))]\n  });\n  const [showingAssociated, setShowingAssociated] = useState(false);\n  const [activeMercadoPbl, setActiveMercadoPbl] = useState(null);\n  const [modoCorreccion, setModoCorreccion] = useState(null);\n\n  // --- Helpers de UI (Draggable & Resize) ---\n  const makeDraggable = useCallback(popup => {\n    if (!map || !popup || !popup._container) return;\n    try {\n      const pos = map.latLngToLayerPoint(popup.getLatLng());\n      L.DomUtil.setPosition(popup._wrapper.parentNode, pos);\n      const draggable = new L.Draggable(popup._container, popup._wrapper);\n      draggable.enable();\n    } catch (error) {\n      console.error('Error draggable:', error);\n    }\n  }, [map]);\n  const crearGripEnWrapper = useCallback(popupContainer => {\n    const wrapper = popupContainer.querySelector('.leaflet-popup-content-wrapper');\n    const content = popupContainer.querySelector('.leaflet-popup-content');\n    if (!wrapper || !content) return;\n    content === null || content === void 0 ? void 0 : content.querySelectorAll('.popup-resize-grip').forEach(n => n.remove());\n    const handleWheel = e => {\n      e.preventDefault();\n      const scrollSpeed = 0.5;\n      const scrollAmount = e.deltaY * scrollSpeed;\n      content.scrollTop += scrollAmount;\n    };\n    content.addEventListener('wheel', handleWheel, {\n      passive: false\n    });\n    let grip = wrapper.querySelector('.popup-resize-grip');\n    if (!grip) {\n      grip = document.createElement('div');\n      grip.className = 'popup-resize-grip';\n      wrapper.appendChild(grip);\n      let isResizing = false;\n      const doResize = e => {\n        if (!isResizing) return;\n        const clientX = e.clientX || e.touches && e.touches[0].clientX;\n        const clientY = e.clientY || e.touches && e.touches[0].clientY;\n        const gripRect = grip.getBoundingClientRect();\n        const gripCenterX = gripRect.left + gripRect.width / 2;\n        const gripCenterY = gripRect.top + gripRect.height / 2;\n        const deltaX = clientX - gripCenterX;\n        const deltaY = clientY - gripCenterY;\n        if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {\n          const currentRect = content.getBoundingClientRect();\n          const newWidth = Math.max(240, currentRect.width + deltaX);\n          const newHeight = Math.max(180, currentRect.height + deltaY);\n          content.style.width = newWidth + 'px';\n          content.style.height = newHeight + 'px';\n        }\n        e.preventDefault();\n      };\n      const stopResize = () => {\n        if (!isResizing) return;\n        isResizing = false;\n        document.body.classList.remove('is-resizing-popup');\n        document.body.style.cursor = '';\n        document.body.style.userSelect = '';\n\n        // Remove listeners when resize stops\n        document.removeEventListener('mousemove', doResize);\n        document.removeEventListener('mouseup', stopResize);\n        document.removeEventListener('touchmove', doResize);\n        document.removeEventListener('touchend', stopResize);\n      };\n      const startResize = e => {\n        isResizing = true;\n        document.body.classList.add('is-resizing-popup');\n        document.body.style.cursor = 'nwse-resize';\n        document.body.style.userSelect = 'none';\n        e.preventDefault();\n        e.stopPropagation();\n\n        // Add listeners only when resize starts\n        document.addEventListener('mousemove', doResize);\n        document.addEventListener('mouseup', stopResize);\n        document.addEventListener('touchmove', doResize, {\n          passive: false\n        });\n        document.addEventListener('touchend', stopResize);\n      };\n\n      // Only add mousedown/touchstart listeners to the grip\n      grip.addEventListener('mousedown', startResize);\n      grip.addEventListener('touchstart', startResize, {\n        passive: false\n      });\n      const cleanup = () => {\n        content.removeEventListener('wheel', handleWheel);\n        grip.removeEventListener('mousedown', startResize);\n        grip.removeEventListener('touchstart', startResize);\n        // Clean up any active resize listeners\n        document.removeEventListener('mousemove', doResize);\n        document.removeEventListener('mouseup', stopResize);\n        document.removeEventListener('touchmove', doResize);\n        document.removeEventListener('touchend', stopResize);\n        document.body.classList.remove('is-resizing-popup');\n      };\n      grip._cleanup = cleanup;\n    }\n  }, []);\n\n  // --- Helpers de limpieza ---\n  const clearCompetenciaMarkers = useCallback(() => {\n    competenciaMarkersRef.current.forEach(marker => {\n      try {\n        if (map && map.hasLayer(marker)) map.removeLayer(marker);\n      } catch (e) {}\n    });\n    competenciaMarkersRef.current = [];\n  }, [map]);\n  const clearPolylines = useCallback(() => {\n    polylineRef.current.forEach(line => {\n      try {\n        if (map && map.hasLayer(line)) map.removeLayer(line);\n      } catch (e) {}\n    });\n    polylineRef.current = [];\n  }, [map]);\n  const clearGuerraMarkers = useCallback(() => {\n    Object.values(guerraMarkersRef.current).forEach(marker => {\n      try {\n        if (map && map.hasLayer(marker)) map.removeLayer(marker);\n      } catch (e) {}\n    });\n    guerraMarkersRef.current = {};\n  }, [map]);\n\n  // --- Handlers ---\n  const handleActivateCoords = useCallback(marker => {\n    if (modoCorreccion && (modoCorreccion.id === marker.id || modoCorreccion.pbl === marker.pbl)) {\n      // Si ya est谩 activo para este marcador, lo desactivamos (cancelar)\n      setModoCorreccion(null);\n      if (map) map.getContainer().style.cursor = '';\n      return;\n    }\n    if (map) map.getContainer().style.cursor = 'crosshair';\n    setModoCorreccion({\n      pbl: marker.pbl,\n      id: marker.id,\n      eds: marker.eds,\n      marca: marker.Marca,\n      lat: null,\n      lng: null\n    });\n  }, [map, modoCorreccion]);\n  const handleSaveCoords = useCallback(async marker => {\n    if (!modoCorreccion || !modoCorreccion.lat || !modoCorreccion.lng) return;\n    try {\n      const coordenada = {\n        id: marker.id || marker.pbl,\n        pbl: marker.pbl || marker.id,\n        eds: marker.eds || '',\n        marca: marker.Marca || '',\n        comuna: marker.Comuna || '',\n        lat_corregida: modoCorreccion.lat,\n        lon_corregida: modoCorreccion.lng\n      };\n      await guardarCoordenadaCorregida(coordenada);\n\n      // Actualizar marcador localmente\n      marker.lat = modoCorreccion.lat;\n      marker.lng = modoCorreccion.lng;\n\n      // Resetear modo correcci贸n\n      setModoCorreccion(null);\n      if (map) map.getContainer().style.cursor = '';\n\n      // Actualizar marcador en el mapa\n      const leafletMarker = markersRef.current[marker.id];\n      if (leafletMarker) {\n        const newLatLng = new L.LatLng(modoCorreccion.lat, modoCorreccion.lng);\n        leafletMarker.setLatLng(newLatLng);\n      }\n    } catch (error) {\n      console.error(\"Error guardando coordenadas:\", error);\n    }\n  }, [modoCorreccion, map, clearGuerraMarkers]);\n\n  // --- Refs para romper ciclo de dependencias ---\n  const showAssociatedIdsRef = useRef(null);\n  const handleActivateCoordsRef = useRef(handleActivateCoords);\n  const handleSaveCoordsRef = useRef(handleSaveCoords);\n  const modoCorreccionRef = useRef(modoCorreccion);\n  const nivel2EnNivel1StationsRef = useRef(nivel2EnNivel1Stations);\n  const onToggleNivel2EnNivel1Ref = useRef(onToggleNivel2EnNivel1);\n  useEffect(() => {\n    handleActivateCoordsRef.current = handleActivateCoords;\n    handleSaveCoordsRef.current = handleSaveCoords;\n    modoCorreccionRef.current = modoCorreccion;\n    nivel2EnNivel1StationsRef.current = nivel2EnNivel1Stations;\n    onToggleNivel2EnNivel1Ref.current = onToggleNivel2EnNivel1;\n  });\n\n  // Helper para Guerra Marker\n  const addGuerraMarker = useCallback(marker => {\n    if (marker.Guerra_Precio === 'Si') {\n      const guerraIcon = L.icon({\n        iconUrl: `${process.env.PUBLIC_URL}/iconos/calavera.jpg`,\n        iconSize: [15, 15],\n        iconAnchor: [7.5, 7.5],\n        className: 'icono-guerra'\n      });\n      const guerraMarker = L.marker([marker.lat, marker.lng], {\n        icon: guerraIcon,\n        interactive: false,\n        isAppMarker: true // Tag for cleanup\n      });\n      map.addLayer(guerraMarker);\n      guerraMarkersRef.current[marker.id] = guerraMarker;\n    }\n  }, [map]);\n\n  // --- Crear Marcador con Popup React ---\n  const createMarkerWithPopup = useCallback((marker, allMarkers, variant = 'primary') => {\n    const lat = parseFloat(marker.lat);\n    const lng = parseFloat(marker.lng);\n    if (isNaN(lat) || isNaN(lng)) return null;\n    const iconUrl = createCustomIcon(marker.Marca);\n    const leafletMarker = L.marker([lat, lng], {\n      icon: iconUrl,\n      isAppMarker: true // Tag for cleanup\n    });\n\n    // Popup vac铆o inicial\n    const popup = L.popup({\n      autoClose: false,\n      closeOnClick: false,\n      keepInView: true,\n      autoPan: false,\n      maxWidth: 450,\n      className: 'custom-popup'\n    }).setContent('<div id=\"popup-root-' + marker.id + '\"></div>');\n    leafletMarker.bindPopup(popup);\n    leafletMarker.on('popupopen', e => {\n      makeDraggable(popup);\n      const container = e.popup._contentNode;\n      const wrapperContainer = e.popup._container;\n      if (wrapperContainer) {\n        crearGripEnWrapper(wrapperContainer);\n      }\n      setTimeout(() => {\n        const rootDiv = document.getElementById('popup-root-' + marker.id);\n        if (rootDiv && !rootDiv._reactRoot) {\n          const root = ReactDOM.createRoot(rootDiv);\n          rootDiv._reactRoot = root;\n          root.render(/*#__PURE__*/_jsxDEV(MapPopup, {\n            marker: marker,\n            allMarkers: allMarkers,\n            onShowAssociated: (...args) => showAssociatedIdsRef.current && showAssociatedIdsRef.current(...args),\n            onActivateCoords: (...args) => handleActivateCoordsRef.current && handleActivateCoordsRef.current(...args),\n            onSaveCoords: (...args) => handleSaveCoordsRef.current && handleSaveCoordsRef.current(...args),\n            modoCorreccion: modoCorreccionRef.current,\n            variant: variant,\n            nivel2EnNivel1Stations: nivel2EnNivel1StationsRef.current,\n            onToggleNivel2EnNivel1: (...args) => onToggleNivel2EnNivel1Ref.current && onToggleNivel2EnNivel1Ref.current(...args)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 290,\n            columnNumber: 13\n          }, this));\n        }\n      }, 0);\n    });\n    leafletMarker.on('popupclose', e => {\n      var _e$popup;\n      const container = (_e$popup = e.popup) === null || _e$popup === void 0 ? void 0 : _e$popup._container;\n      if (container) {\n        const wrapper = container.querySelector('.leaflet-popup-content-wrapper');\n        const grip = wrapper === null || wrapper === void 0 ? void 0 : wrapper.querySelector('.popup-resize-grip');\n        if (grip && grip._cleanup) {\n          grip._cleanup();\n        }\n      }\n      const rootDiv = document.getElementById('popup-root-' + marker.id);\n      if (rootDiv && rootDiv._reactRoot) {\n        setTimeout(() => {\n          if (rootDiv._reactRoot) {\n            rootDiv._reactRoot.unmount();\n            rootDiv._reactRoot = null;\n          }\n        }, 0);\n      }\n    });\n    return leafletMarker;\n  }, [makeDraggable, crearGripEnWrapper]);\n\n  // --- L贸gica de Mercado (Show Associated) ---\n  const showAssociatedIds = useCallback((pbl, lat, lng, originalMarkerId) => {\n    const searchArray = markersForMercado && markersForMercado.length > 0 ? markersForMercado : markers;\n    console.log(' MERCADO BUTTON CLICKED:', {\n      pbl,\n      searchArrayLength: searchArray.length,\n      markersForMercadoLength: markersForMercado === null || markersForMercado === void 0 ? void 0 : markersForMercado.length,\n      markersLength: markers.length,\n      baseCompDataLength: baseCompData.length\n    });\n\n    // Toggle ON (o cambio de PBL)\n    // Definir associatedData aqu铆\n    const associatedData = baseCompData.filter(item => String(item.pbl).trim() === String(pbl).trim());\n    console.log(' ASSOCIATED DATA:', {\n      pbl,\n      associatedDataLength: associatedData.length,\n      associatedIds: associatedData.map(item => item.id),\n      sampleAssociatedData: associatedData.slice(0, 3)\n    });\n    if (showingAssociated && activeMercadoPbl === pbl) {\n      // Toggle OFF\n      clearCompetenciaMarkers();\n      clearPolylines();\n      setShowingAssociated(false);\n      setActiveMercadoPbl(null);\n\n      // Restaurar marcadores originales\n      Object.values(markersRef.current).forEach(marker => {\n        try {\n          if (map && map.hasLayer(marker)) map.removeLayer(marker);\n        } catch (e) {}\n      });\n      markersRef.current = {};\n\n      // Re-crear todos\n      markers.forEach(marker => {\n        const leafletMarker = createMarkerWithPopup(marker, markersForMercado || markers, 'primary');\n        if (leafletMarker) {\n          map.addLayer(leafletMarker);\n          markersRef.current[marker.id] = leafletMarker;\n          addGuerraMarker(marker);\n        }\n      });\n      return;\n    }\n\n    // Si no hay datos asociados, no hacemos nada\n    if (associatedData.length === 0) {\n      console.warn('锔 NO ASSOCIATED DATA FOUND for PBL:', pbl);\n      return;\n    }\n\n    // Toggle ON\n\n    // 1. Limpiar TODOS los marcadores actuales del mapa\n    Object.values(markersRef.current).forEach(marker => {\n      try {\n        if (map && map.hasLayer(marker)) map.removeLayer(marker);\n      } catch (e) {}\n    });\n    markersRef.current = {}; // Reiniciar referencia de marcadores\n\n    // Limpiar otros elementos\n    clearCompetenciaMarkers();\n    clearPolylines();\n    Object.values(guerraMarkersRef.current).forEach(marker => {\n      try {\n        if (map && map.hasLayer(marker)) map.removeLayer(marker);\n      } catch (e) {}\n    });\n    guerraMarkersRef.current = {};\n    const ids = associatedData.map(item => item.id);\n\n    // Get unique IDs from associatedData\n    const uniqueIds = [...new Set(ids)];\n\n    // Encontrar estaci贸n principal y competencia\n    const mainStation = searchArray.find(m => String(m.pbl).trim() === String(pbl).trim());\n    const associatedMarkers = searchArray.filter(item => ids.includes(item.id));\n    console.log(' MERCADO MODE ACTIVATED:', {\n      mainStation: mainStation ? mainStation.id : 'Not Found',\n      competitorsFound: associatedMarkers.length,\n      uniqueCompetitorsIds: uniqueIds\n    });\n\n    // Lista final de marcadores a mostrar (Principal + Competencia)\n    const markersToShow = [];\n    const seenIds = new Set();\n\n    // Agregar estaci贸n principal primero (si existe)\n    if (mainStation) {\n      markersToShow.push({\n        ...mainStation,\n        isMain: true\n      });\n      seenIds.add(mainStation.id);\n    }\n\n    // Agregar competencia\n    associatedMarkers.forEach(marker => {\n      if (!seenIds.has(marker.id)) {\n        seenIds.add(marker.id);\n        markersToShow.push({\n          ...marker,\n          isMain: false\n        });\n      }\n    });\n\n    // Renderizar los marcadores filtrados\n    markersToShow.forEach(marker => {\n      // Usar 'primary' para la principal, 'secondary' para competencia\n      const variant = marker.isMain ? 'primary' : 'secondary';\n      // Usar markersForMercado o baseCompData como fuente de datos para el popup\n      const dataSource = markersForMercado || baseCompData;\n      const leafletMarker = createMarkerWithPopup(marker, dataSource, variant);\n      if (leafletMarker) {\n        map.addLayer(leafletMarker);\n        // Guardar en markersRef para que funcionen como marcadores normales (popup, drag, etc)\n        markersRef.current[marker.id] = leafletMarker;\n\n        // Agregar marcador de guerra si corresponde\n        addGuerraMarker(marker);\n      }\n    });\n\n    // Polylines (L铆neas de conexi贸n)\n    const mainMarkersData = associatedData.filter(m => m.Marcador_Principal === 'Si');\n    mainMarkersData.forEach(mainMarker => {\n      const markerWithCoords = searchArray.find(m => m.id === mainMarker.id);\n      if (!markerWithCoords) return;\n      const mainLat = parseFloat(markerWithCoords.lat);\n      const mainLng = parseFloat(markerWithCoords.lng);\n      if (isNaN(mainLat) || isNaN(mainLng)) return;\n      const polyline = L.polyline([[parseFloat(lat), parseFloat(lng)], [mainLat, mainLng]], {\n        color: '#FF6B6B',\n        weight: 3,\n        opacity: 0.8,\n        dashArray: '5, 5'\n      }).addTo(map);\n      polylineRef.current.push(polyline);\n    });\n    setShowingAssociated(true);\n    setActiveMercadoPbl(pbl);\n  }, [baseCompData, markers, markersForMercado, map, showingAssociated, activeMercadoPbl, clearCompetenciaMarkers, clearPolylines, clearGuerraMarkers, createMarkerWithPopup, addGuerraMarker]);\n  useEffect(() => {\n    showAssociatedIdsRef.current = showAssociatedIds;\n  }, [showAssociatedIds]);\n\n  // --- Efecto Principal de Renderizado ---\n  useEffect(() => {\n    if (!map || !markers || markers.length === 0) return;\n\n    // Robust Cleanup: Remove ALL markers tagged as isAppMarker\n    // This ensures we don't leave zombie markers if refs are lost\n    map.eachLayer(layer => {\n      if (layer.options && layer.options.isAppMarker) {\n        map.removeLayer(layer);\n      }\n    });\n\n    // Reset refs\n    markersRef.current = {};\n    guerraMarkersRef.current = {};\n    competenciaMarkersRef.current = [];\n    polylineRef.current = []; // Polylines might need tagging too if they persist, but let's clear them via ref for now or tag them\n\n    clearCompetenciaMarkers();\n    clearPolylines();\n    setShowingAssociated(false);\n    setActiveMercadoPbl(null);\n    markers.forEach(marker => {\n      const leafletMarker = createMarkerWithPopup(marker, markersForMercado || markers, 'primary');\n      if (leafletMarker) {\n        map.addLayer(leafletMarker);\n        markersRef.current[marker.id] = leafletMarker;\n        addGuerraMarker(marker);\n      }\n    });\n    if (markers.length === 1 && markersRef.current[markers[0].id]) {\n      markersRef.current[markers[0].id].openPopup();\n    }\n  }, [map, markers, markersForMercado, selectedRegion, clearCompetenciaMarkers, clearPolylines, clearGuerraMarkers, createMarkerWithPopup, addGuerraMarker]);\n\n  // --- Efecto para Click en Mapa (Correcci贸n Coordenadas) ---\n  useEffect(() => {\n    if (!map || !modoCorreccion) return;\n    const handleMapClick = e => {\n      const {\n        lat,\n        lng\n      } = e.latlng;\n      setModoCorreccion(prev => ({\n        ...prev,\n        lat,\n        lng\n      }));\n    };\n    map.on('click', handleMapClick);\n    return () => {\n      map.off('click', handleMapClick);\n    };\n  }, [map, modoCorreccion]);\n\n  // --- Efecto para Actualizar Popups cuando cambia modoCorreccion ---\n  useEffect(() => {\n    if (!map) return;\n\n    // Iterar sobre los popups abiertos y re-renderizarlos con el nuevo estado\n    map.eachLayer(layer => {\n      if (layer.getPopup && layer.getPopup() && layer.getPopup().isOpen()) {\n        const markerId = Object.keys(markersRef.current).find(key => markersRef.current[key] === layer);\n        if (markerId) {\n          const marker = markers.find(m => m.id === markerId) || (markersForMercado || []).find(m => m.id === markerId);\n          if (marker) {\n            const rootDiv = document.getElementById('popup-root-' + marker.id);\n            if (rootDiv && rootDiv._reactRoot) {\n              rootDiv._reactRoot.render(/*#__PURE__*/_jsxDEV(MapPopup, {\n                marker: marker,\n                allMarkers: markersForMercado || markers,\n                onShowAssociated: (...args) => showAssociatedIdsRef.current && showAssociatedIdsRef.current(...args),\n                onActivateCoords: (...args) => handleActivateCoordsRef.current && handleActivateCoordsRef.current(...args),\n                onSaveCoords: (...args) => handleSaveCoordsRef.current && handleSaveCoordsRef.current(...args),\n                modoCorreccion: modoCorreccion // Usamos el valor actual del estado\n                ,\n                variant: markersForMercado && markersForMercado.includes(marker) ? 'secondary' : 'primary',\n                nivel2EnNivel1Stations: nivel2EnNivel1Stations // En el efecto usamos el valor directo porque el efecto depende de 茅l\n                ,\n                onToggleNivel2EnNivel1: onToggleNivel2EnNivel1\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 547,\n                columnNumber: 17\n              }, this));\n            }\n          }\n        }\n      }\n    });\n  }, [modoCorreccion, map, markers, markersForMercado, nivel2EnNivel1Stations, onToggleNivel2EnNivel1]);\n\n  // Re-render open popups when markers data updates (auto-refresh)\n  useEffect(() => {\n    if (!map) return;\n    map.eachLayer(layer => {\n      if (layer instanceof L.Marker && layer.getPopup && layer.getPopup()) {\n        const popup = layer.getPopup();\n        if (popup.isOpen()) {\n          const markerData = layer.options.markerData;\n          if (markerData && markerData.pbl) {\n            // Find updated marker data\n            const updatedMarker = markers.find(m => m.pbl === markerData.pbl);\n            if (updatedMarker) {\n              var _popup$getElement;\n              const rootDiv = (_popup$getElement = popup.getElement()) === null || _popup$getElement === void 0 ? void 0 : _popup$getElement.querySelector('.popup-root');\n              if (rootDiv && rootDiv._reactRoot) {\n                // Re-render with updated data\n                rootDiv._reactRoot.render(/*#__PURE__*/_jsxDEV(MapPopup, {\n                  marker: updatedMarker,\n                  allMarkers: markersForMercado || markers,\n                  onShowAssociated: (...args) => showAssociatedIdsRef.current && showAssociatedIdsRef.current(...args),\n                  onActivateCoords: (...args) => handleActivateCoordsRef.current && handleActivateCoordsRef.current(...args),\n                  onSaveCoords: (...args) => handleSaveCoordsRef.current && handleSaveCoordsRef.current(...args),\n                  modoCorreccion: modoCorreccion,\n                  variant: markersForMercado && markersForMercado.includes(updatedMarker) ? 'secondary' : 'primary',\n                  nivel2EnNivel1Stations: nivel2EnNivel1Stations // En el efecto usamos el valor directo\n                  ,\n                  onToggleNivel2EnNivel1: onToggleNivel2EnNivel1\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 583,\n                  columnNumber: 19\n                }, this));\n              }\n            }\n          }\n        }\n      }\n    });\n  }, [markers, map, markersForMercado, modoCorreccion, nivel2EnNivel1Stations, onToggleNivel2EnNivel1]);\n  return null;\n};\n_s(IconMarkersLayer, \"7YJQzV+/RsSLBDcdDz4cWWsd4/A=\", false, function () {\n  return [useMap];\n});\n_c = IconMarkersLayer;\nexport default IconMarkersLayer;\nvar _c;\n$RefreshReg$(_c, \"IconMarkersLayer\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useCallback","useMap","L","ReactDOM","createCustomIcon","guardarCoordenadaCorregida","MapPopup","jsxDEV","_jsxDEV","IconMarkersLayer","markers","markersForMercado","selectedRegion","baseCompData","nivel2EnNivel1Stations","onToggleNivel2EnNivel1","_s","_markers$","map","markersRef","guerraMarkersRef","competenciaMarkersRef","polylineRef","console","log","markersCount","length","markersRefCount","Object","keys","current","firstMarkerComuna","Comuna","uniqueComunas","Set","m","showingAssociated","setShowingAssociated","activeMercadoPbl","setActiveMercadoPbl","modoCorreccion","setModoCorreccion","makeDraggable","popup","_container","pos","latLngToLayerPoint","getLatLng","DomUtil","setPosition","_wrapper","parentNode","draggable","Draggable","enable","error","crearGripEnWrapper","popupContainer","wrapper","querySelector","content","querySelectorAll","forEach","n","remove","handleWheel","e","preventDefault","scrollSpeed","scrollAmount","deltaY","scrollTop","addEventListener","passive","grip","document","createElement","className","appendChild","isResizing","doResize","clientX","touches","clientY","gripRect","getBoundingClientRect","gripCenterX","left","width","gripCenterY","top","height","deltaX","Math","abs","currentRect","newWidth","max","newHeight","style","stopResize","body","classList","cursor","userSelect","removeEventListener","startResize","add","stopPropagation","cleanup","_cleanup","clearCompetenciaMarkers","marker","hasLayer","removeLayer","clearPolylines","line","clearGuerraMarkers","values","handleActivateCoords","id","pbl","getContainer","eds","marca","Marca","lat","lng","handleSaveCoords","coordenada","comuna","lat_corregida","lon_corregida","leafletMarker","newLatLng","LatLng","setLatLng","showAssociatedIdsRef","handleActivateCoordsRef","handleSaveCoordsRef","modoCorreccionRef","nivel2EnNivel1StationsRef","onToggleNivel2EnNivel1Ref","addGuerraMarker","Guerra_Precio","guerraIcon","icon","iconUrl","process","env","PUBLIC_URL","iconSize","iconAnchor","guerraMarker","interactive","isAppMarker","addLayer","createMarkerWithPopup","allMarkers","variant","parseFloat","isNaN","autoClose","closeOnClick","keepInView","autoPan","maxWidth","setContent","bindPopup","on","container","_contentNode","wrapperContainer","setTimeout","rootDiv","getElementById","_reactRoot","root","createRoot","render","onShowAssociated","args","onActivateCoords","onSaveCoords","fileName","_jsxFileName","lineNumber","columnNumber","_e$popup","unmount","showAssociatedIds","originalMarkerId","searchArray","searchArrayLength","markersForMercadoLength","markersLength","baseCompDataLength","associatedData","filter","item","String","trim","associatedDataLength","associatedIds","sampleAssociatedData","slice","warn","ids","uniqueIds","mainStation","find","associatedMarkers","includes","competitorsFound","uniqueCompetitorsIds","markersToShow","seenIds","push","isMain","has","dataSource","mainMarkersData","Marcador_Principal","mainMarker","markerWithCoords","mainLat","mainLng","polyline","color","weight","opacity","dashArray","addTo","eachLayer","layer","options","openPopup","handleMapClick","latlng","prev","off","getPopup","isOpen","markerId","key","Marker","markerData","updatedMarker","_popup$getElement","getElement","_c","$RefreshReg$"],"sources":["C:/Users/e08f/Desktop/Proyectos/Resumen/mapa-v2/src/components/IconMarkersLayer.jsx"],"sourcesContent":["import React, { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { useMap } from 'react-leaflet';\r\nimport L from 'leaflet';\r\nimport ReactDOM from 'react-dom/client';\r\nimport { createCustomIcon } from '../utils/iconHelpers';\r\nimport { guardarCoordenadaCorregida } from '../services/apiService';\r\nimport MapPopup from './MapPopup';\r\nimport '../styles/iconMarkersLayer.css';\r\n\r\nconst IconMarkersLayer = ({ markers, markersForMercado = null, selectedRegion, baseCompData = [], nivel2EnNivel1Stations = [], onToggleNivel2EnNivel1 }) => {\r\n  const map = useMap();\r\n  const markersRef = useRef({});\r\n  const guerraMarkersRef = useRef({});\r\n  const competenciaMarkersRef = useRef([]);\r\n  const polylineRef = useRef([]);\r\n\r\n  console.log(' IconMarkersLayer RENDER:', {\r\n    markersCount: markers?.length,\r\n    markersRefCount: Object.keys(markersRef.current).length,\r\n    selectedRegion,\r\n    firstMarkerComuna: markers?.[0]?.Comuna,\r\n    uniqueComunas: [...new Set((markers || []).map(m => m.Comuna))]\r\n  });\r\n\r\n  const [showingAssociated, setShowingAssociated] = useState(false);\r\n  const [activeMercadoPbl, setActiveMercadoPbl] = useState(null);\r\n  const [modoCorreccion, setModoCorreccion] = useState(null);\r\n\r\n  // --- Helpers de UI (Draggable & Resize) ---\r\n  const makeDraggable = useCallback((popup) => {\r\n    if (!map || !popup || !popup._container) return;\r\n    try {\r\n      const pos = map.latLngToLayerPoint(popup.getLatLng());\r\n      L.DomUtil.setPosition(popup._wrapper.parentNode, pos);\r\n      const draggable = new L.Draggable(popup._container, popup._wrapper);\r\n      draggable.enable();\r\n    } catch (error) {\r\n      console.error('Error draggable:', error);\r\n    }\r\n  }, [map]);\r\n\r\n  const crearGripEnWrapper = useCallback((popupContainer) => {\r\n    const wrapper = popupContainer.querySelector('.leaflet-popup-content-wrapper');\r\n    const content = popupContainer.querySelector('.leaflet-popup-content');\r\n    if (!wrapper || !content) return;\r\n\r\n    content?.querySelectorAll('.popup-resize-grip').forEach(n => n.remove());\r\n\r\n    const handleWheel = (e) => {\r\n      e.preventDefault();\r\n      const scrollSpeed = 0.5;\r\n      const scrollAmount = e.deltaY * scrollSpeed;\r\n      content.scrollTop += scrollAmount;\r\n    };\r\n\r\n    content.addEventListener('wheel', handleWheel, { passive: false });\r\n\r\n    let grip = wrapper.querySelector('.popup-resize-grip');\r\n    if (!grip) {\r\n      grip = document.createElement('div');\r\n      grip.className = 'popup-resize-grip';\r\n      wrapper.appendChild(grip);\r\n\r\n      let isResizing = false;\r\n\r\n      const doResize = (e) => {\r\n        if (!isResizing) return;\r\n\r\n        const clientX = e.clientX || (e.touches && e.touches[0].clientX);\r\n        const clientY = e.clientY || (e.touches && e.touches[0].clientY);\r\n\r\n        const gripRect = grip.getBoundingClientRect();\r\n        const gripCenterX = gripRect.left + gripRect.width / 2;\r\n        const gripCenterY = gripRect.top + gripRect.height / 2;\r\n\r\n        const deltaX = clientX - gripCenterX;\r\n        const deltaY = clientY - gripCenterY;\r\n\r\n        if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {\r\n          const currentRect = content.getBoundingClientRect();\r\n          const newWidth = Math.max(240, currentRect.width + deltaX);\r\n          const newHeight = Math.max(180, currentRect.height + deltaY);\r\n\r\n          content.style.width = newWidth + 'px';\r\n          content.style.height = newHeight + 'px';\r\n        }\r\n\r\n        e.preventDefault();\r\n      };\r\n\r\n      const stopResize = () => {\r\n        if (!isResizing) return;\r\n        isResizing = false;\r\n        document.body.classList.remove('is-resizing-popup');\r\n        document.body.style.cursor = '';\r\n        document.body.style.userSelect = '';\r\n\r\n        // Remove listeners when resize stops\r\n        document.removeEventListener('mousemove', doResize);\r\n        document.removeEventListener('mouseup', stopResize);\r\n        document.removeEventListener('touchmove', doResize);\r\n        document.removeEventListener('touchend', stopResize);\r\n      };\r\n\r\n      const startResize = (e) => {\r\n        isResizing = true;\r\n        document.body.classList.add('is-resizing-popup');\r\n        document.body.style.cursor = 'nwse-resize';\r\n        document.body.style.userSelect = 'none';\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        // Add listeners only when resize starts\r\n        document.addEventListener('mousemove', doResize);\r\n        document.addEventListener('mouseup', stopResize);\r\n        document.addEventListener('touchmove', doResize, { passive: false });\r\n        document.addEventListener('touchend', stopResize);\r\n      };\r\n\r\n      // Only add mousedown/touchstart listeners to the grip\r\n      grip.addEventListener('mousedown', startResize);\r\n      grip.addEventListener('touchstart', startResize, { passive: false });\r\n\r\n      const cleanup = () => {\r\n        content.removeEventListener('wheel', handleWheel);\r\n        grip.removeEventListener('mousedown', startResize);\r\n        grip.removeEventListener('touchstart', startResize);\r\n        // Clean up any active resize listeners\r\n        document.removeEventListener('mousemove', doResize);\r\n        document.removeEventListener('mouseup', stopResize);\r\n        document.removeEventListener('touchmove', doResize);\r\n        document.removeEventListener('touchend', stopResize);\r\n        document.body.classList.remove('is-resizing-popup');\r\n      };\r\n\r\n      grip._cleanup = cleanup;\r\n    }\r\n  }, []);\r\n\r\n  // --- Helpers de limpieza ---\r\n  const clearCompetenciaMarkers = useCallback(() => {\r\n    competenciaMarkersRef.current.forEach(marker => {\r\n      try { if (map && map.hasLayer(marker)) map.removeLayer(marker); } catch (e) { }\r\n    });\r\n    competenciaMarkersRef.current = [];\r\n  }, [map]);\r\n\r\n  const clearPolylines = useCallback(() => {\r\n    polylineRef.current.forEach(line => {\r\n      try { if (map && map.hasLayer(line)) map.removeLayer(line); } catch (e) { }\r\n    });\r\n    polylineRef.current = [];\r\n  }, [map]);\r\n\r\n  const clearGuerraMarkers = useCallback(() => {\r\n    Object.values(guerraMarkersRef.current).forEach(marker => {\r\n      try { if (map && map.hasLayer(marker)) map.removeLayer(marker); } catch (e) { }\r\n    });\r\n    guerraMarkersRef.current = {};\r\n  }, [map]);\r\n\r\n  // --- Handlers ---\r\n  const handleActivateCoords = useCallback((marker) => {\r\n    if (modoCorreccion && (modoCorreccion.id === marker.id || modoCorreccion.pbl === marker.pbl)) {\r\n      // Si ya est谩 activo para este marcador, lo desactivamos (cancelar)\r\n      setModoCorreccion(null);\r\n      if (map) map.getContainer().style.cursor = '';\r\n      return;\r\n    }\r\n\r\n    if (map) map.getContainer().style.cursor = 'crosshair';\r\n    setModoCorreccion({\r\n      pbl: marker.pbl,\r\n      id: marker.id,\r\n      eds: marker.eds,\r\n      marca: marker.Marca,\r\n      lat: null,\r\n      lng: null\r\n    });\r\n  }, [map, modoCorreccion]);\r\n\r\n  const handleSaveCoords = useCallback(async (marker) => {\r\n    if (!modoCorreccion || !modoCorreccion.lat || !modoCorreccion.lng) return;\r\n\r\n    try {\r\n      const coordenada = {\r\n        id: marker.id || marker.pbl,\r\n        pbl: marker.pbl || marker.id,\r\n        eds: marker.eds || '',\r\n        marca: marker.Marca || '',\r\n        comuna: marker.Comuna || '',\r\n        lat_corregida: modoCorreccion.lat,\r\n        lon_corregida: modoCorreccion.lng\r\n      };\r\n      await guardarCoordenadaCorregida(coordenada);\r\n\r\n      // Actualizar marcador localmente\r\n      marker.lat = modoCorreccion.lat;\r\n      marker.lng = modoCorreccion.lng;\r\n\r\n      // Resetear modo correcci贸n\r\n      setModoCorreccion(null);\r\n      if (map) map.getContainer().style.cursor = '';\r\n\r\n      // Actualizar marcador en el mapa\r\n      const leafletMarker = markersRef.current[marker.id];\r\n      if (leafletMarker) {\r\n        const newLatLng = new L.LatLng(modoCorreccion.lat, modoCorreccion.lng);\r\n        leafletMarker.setLatLng(newLatLng);\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error(\"Error guardando coordenadas:\", error);\r\n    }\r\n  }, [modoCorreccion, map, clearGuerraMarkers]);\r\n\r\n  // --- Refs para romper ciclo de dependencias ---\r\n  const showAssociatedIdsRef = useRef(null);\r\n  const handleActivateCoordsRef = useRef(handleActivateCoords);\r\n  const handleSaveCoordsRef = useRef(handleSaveCoords);\r\n  const modoCorreccionRef = useRef(modoCorreccion);\r\n  const nivel2EnNivel1StationsRef = useRef(nivel2EnNivel1Stations);\r\n  const onToggleNivel2EnNivel1Ref = useRef(onToggleNivel2EnNivel1);\r\n\r\n  useEffect(() => {\r\n    handleActivateCoordsRef.current = handleActivateCoords;\r\n    handleSaveCoordsRef.current = handleSaveCoords;\r\n    modoCorreccionRef.current = modoCorreccion;\r\n    nivel2EnNivel1StationsRef.current = nivel2EnNivel1Stations;\r\n    onToggleNivel2EnNivel1Ref.current = onToggleNivel2EnNivel1;\r\n  });\r\n\r\n  // Helper para Guerra Marker\r\n  const addGuerraMarker = useCallback((marker) => {\r\n    if (marker.Guerra_Precio === 'Si') {\r\n      const guerraIcon = L.icon({\r\n        iconUrl: `${process.env.PUBLIC_URL}/iconos/calavera.jpg`,\r\n        iconSize: [15, 15],\r\n        iconAnchor: [7.5, 7.5],\r\n        className: 'icono-guerra'\r\n      });\r\n      const guerraMarker = L.marker([marker.lat, marker.lng], {\r\n        icon: guerraIcon,\r\n        interactive: false,\r\n        isAppMarker: true // Tag for cleanup\r\n      });\r\n      map.addLayer(guerraMarker);\r\n      guerraMarkersRef.current[marker.id] = guerraMarker;\r\n    }\r\n  }, [map]);\r\n\r\n  // --- Crear Marcador con Popup React ---\r\n  const createMarkerWithPopup = useCallback((marker, allMarkers, variant = 'primary') => {\r\n    const lat = parseFloat(marker.lat);\r\n    const lng = parseFloat(marker.lng);\r\n    if (isNaN(lat) || isNaN(lng)) return null;\r\n\r\n    const iconUrl = createCustomIcon(marker.Marca);\r\n    const leafletMarker = L.marker([lat, lng], {\r\n      icon: iconUrl,\r\n      isAppMarker: true // Tag for cleanup\r\n    });\r\n\r\n    // Popup vac铆o inicial\r\n    const popup = L.popup({\r\n      autoClose: false,\r\n      closeOnClick: false,\r\n      keepInView: true,\r\n      autoPan: false,\r\n      maxWidth: 450,\r\n      className: 'custom-popup'\r\n    }).setContent('<div id=\"popup-root-' + marker.id + '\"></div>');\r\n\r\n    leafletMarker.bindPopup(popup);\r\n\r\n    leafletMarker.on('popupopen', (e) => {\r\n      makeDraggable(popup);\r\n      const container = e.popup._contentNode;\r\n      const wrapperContainer = e.popup._container;\r\n      if (wrapperContainer) {\r\n        crearGripEnWrapper(wrapperContainer);\r\n      }\r\n\r\n      setTimeout(() => {\r\n        const rootDiv = document.getElementById('popup-root-' + marker.id);\r\n        if (rootDiv && !rootDiv._reactRoot) {\r\n          const root = ReactDOM.createRoot(rootDiv);\r\n          rootDiv._reactRoot = root;\r\n          root.render(\r\n            <MapPopup\r\n              marker={marker}\r\n              allMarkers={allMarkers}\r\n              onShowAssociated={(...args) => showAssociatedIdsRef.current && showAssociatedIdsRef.current(...args)}\r\n              onActivateCoords={(...args) => handleActivateCoordsRef.current && handleActivateCoordsRef.current(...args)}\r\n              onSaveCoords={(...args) => handleSaveCoordsRef.current && handleSaveCoordsRef.current(...args)}\r\n              modoCorreccion={modoCorreccionRef.current}\r\n              variant={variant}\r\n              nivel2EnNivel1Stations={nivel2EnNivel1StationsRef.current}\r\n              onToggleNivel2EnNivel1={(...args) => onToggleNivel2EnNivel1Ref.current && onToggleNivel2EnNivel1Ref.current(...args)}\r\n            />\r\n          );\r\n        }\r\n      }, 0);\r\n    });\r\n\r\n    leafletMarker.on('popupclose', (e) => {\r\n      const container = e.popup?._container;\r\n      if (container) {\r\n        const wrapper = container.querySelector('.leaflet-popup-content-wrapper');\r\n        const grip = wrapper?.querySelector('.popup-resize-grip');\r\n        if (grip && grip._cleanup) {\r\n          grip._cleanup();\r\n        }\r\n      }\r\n\r\n      const rootDiv = document.getElementById('popup-root-' + marker.id);\r\n      if (rootDiv && rootDiv._reactRoot) {\r\n        setTimeout(() => {\r\n          if (rootDiv._reactRoot) {\r\n            rootDiv._reactRoot.unmount();\r\n            rootDiv._reactRoot = null;\r\n          }\r\n        }, 0);\r\n      }\r\n    });\r\n\r\n    return leafletMarker;\r\n  }, [makeDraggable, crearGripEnWrapper]);\r\n\r\n  // --- L贸gica de Mercado (Show Associated) ---\r\n  const showAssociatedIds = useCallback((pbl, lat, lng, originalMarkerId) => {\r\n    const searchArray = markersForMercado && markersForMercado.length > 0 ? markersForMercado : markers;\r\n\r\n    console.log(' MERCADO BUTTON CLICKED:', {\r\n      pbl,\r\n      searchArrayLength: searchArray.length,\r\n      markersForMercadoLength: markersForMercado?.length,\r\n      markersLength: markers.length,\r\n      baseCompDataLength: baseCompData.length\r\n    });\r\n\r\n    // Toggle ON (o cambio de PBL)\r\n    // Definir associatedData aqu铆\r\n    const associatedData = baseCompData.filter(item => String(item.pbl).trim() === String(pbl).trim());\r\n\r\n    console.log(' ASSOCIATED DATA:', {\r\n      pbl,\r\n      associatedDataLength: associatedData.length,\r\n      associatedIds: associatedData.map(item => item.id),\r\n      sampleAssociatedData: associatedData.slice(0, 3)\r\n    });\r\n\r\n    if (showingAssociated && activeMercadoPbl === pbl) {\r\n      // Toggle OFF\r\n      clearCompetenciaMarkers();\r\n      clearPolylines();\r\n      setShowingAssociated(false);\r\n      setActiveMercadoPbl(null);\r\n\r\n      // Restaurar marcadores originales\r\n      Object.values(markersRef.current).forEach(marker => {\r\n        try { if (map && map.hasLayer(marker)) map.removeLayer(marker); } catch (e) { }\r\n      });\r\n      markersRef.current = {};\r\n\r\n      // Re-crear todos\r\n      markers.forEach(marker => {\r\n        const leafletMarker = createMarkerWithPopup(marker, markersForMercado || markers, 'primary');\r\n        if (leafletMarker) {\r\n          map.addLayer(leafletMarker);\r\n          markersRef.current[marker.id] = leafletMarker;\r\n          addGuerraMarker(marker);\r\n        }\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Si no hay datos asociados, no hacemos nada\r\n    if (associatedData.length === 0) {\r\n      console.warn('锔 NO ASSOCIATED DATA FOUND for PBL:', pbl);\r\n      return;\r\n    }\r\n\r\n    // Toggle ON\r\n\r\n    // 1. Limpiar TODOS los marcadores actuales del mapa\r\n    Object.values(markersRef.current).forEach(marker => {\r\n      try { if (map && map.hasLayer(marker)) map.removeLayer(marker); } catch (e) { }\r\n    });\r\n    markersRef.current = {}; // Reiniciar referencia de marcadores\r\n\r\n    // Limpiar otros elementos\r\n    clearCompetenciaMarkers();\r\n    clearPolylines();\r\n    Object.values(guerraMarkersRef.current).forEach(marker => {\r\n      try { if (map && map.hasLayer(marker)) map.removeLayer(marker); } catch (e) { }\r\n    });\r\n    guerraMarkersRef.current = {};\r\n\r\n    const ids = associatedData.map(item => item.id);\r\n\r\n    // Get unique IDs from associatedData\r\n    const uniqueIds = [...new Set(ids)];\r\n\r\n    // Encontrar estaci贸n principal y competencia\r\n    const mainStation = searchArray.find(m => String(m.pbl).trim() === String(pbl).trim());\r\n    const associatedMarkers = searchArray.filter(item => ids.includes(item.id));\r\n\r\n    console.log(' MERCADO MODE ACTIVATED:', {\r\n      mainStation: mainStation ? mainStation.id : 'Not Found',\r\n      competitorsFound: associatedMarkers.length,\r\n      uniqueCompetitorsIds: uniqueIds\r\n    });\r\n\r\n    // Lista final de marcadores a mostrar (Principal + Competencia)\r\n    const markersToShow = [];\r\n    const seenIds = new Set();\r\n\r\n    // Agregar estaci贸n principal primero (si existe)\r\n    if (mainStation) {\r\n      markersToShow.push({ ...mainStation, isMain: true });\r\n      seenIds.add(mainStation.id);\r\n    }\r\n\r\n    // Agregar competencia\r\n    associatedMarkers.forEach(marker => {\r\n      if (!seenIds.has(marker.id)) {\r\n        seenIds.add(marker.id);\r\n        markersToShow.push({ ...marker, isMain: false });\r\n      }\r\n    });\r\n\r\n    // Renderizar los marcadores filtrados\r\n    markersToShow.forEach(marker => {\r\n      // Usar 'primary' para la principal, 'secondary' para competencia\r\n      const variant = marker.isMain ? 'primary' : 'secondary';\r\n      // Usar markersForMercado o baseCompData como fuente de datos para el popup\r\n      const dataSource = markersForMercado || baseCompData;\r\n\r\n      const leafletMarker = createMarkerWithPopup(marker, dataSource, variant);\r\n\r\n      if (leafletMarker) {\r\n        map.addLayer(leafletMarker);\r\n        // Guardar en markersRef para que funcionen como marcadores normales (popup, drag, etc)\r\n        markersRef.current[marker.id] = leafletMarker;\r\n\r\n        // Agregar marcador de guerra si corresponde\r\n        addGuerraMarker(marker);\r\n      }\r\n    });\r\n\r\n    // Polylines (L铆neas de conexi贸n)\r\n    const mainMarkersData = associatedData.filter(m => m.Marcador_Principal === 'Si');\r\n    mainMarkersData.forEach(mainMarker => {\r\n      const markerWithCoords = searchArray.find(m => m.id === mainMarker.id);\r\n      if (!markerWithCoords) return;\r\n      const mainLat = parseFloat(markerWithCoords.lat);\r\n      const mainLng = parseFloat(markerWithCoords.lng);\r\n      if (isNaN(mainLat) || isNaN(mainLng)) return;\r\n\r\n      const polyline = L.polyline(\r\n        [[parseFloat(lat), parseFloat(lng)], [mainLat, mainLng]],\r\n        { color: '#FF6B6B', weight: 3, opacity: 0.8, dashArray: '5, 5' }\r\n      ).addTo(map);\r\n      polylineRef.current.push(polyline);\r\n    });\r\n\r\n    setShowingAssociated(true);\r\n    setActiveMercadoPbl(pbl);\r\n\r\n  }, [baseCompData, markers, markersForMercado, map, showingAssociated, activeMercadoPbl, clearCompetenciaMarkers, clearPolylines, clearGuerraMarkers, createMarkerWithPopup, addGuerraMarker]);\r\n\r\n  useEffect(() => {\r\n    showAssociatedIdsRef.current = showAssociatedIds;\r\n  }, [showAssociatedIds]);\r\n\r\n  // --- Efecto Principal de Renderizado ---\r\n  useEffect(() => {\r\n    if (!map || !markers || markers.length === 0) return;\r\n\r\n    // Robust Cleanup: Remove ALL markers tagged as isAppMarker\r\n    // This ensures we don't leave zombie markers if refs are lost\r\n    map.eachLayer(layer => {\r\n      if (layer.options && layer.options.isAppMarker) {\r\n        map.removeLayer(layer);\r\n      }\r\n    });\r\n\r\n    // Reset refs\r\n    markersRef.current = {};\r\n    guerraMarkersRef.current = {};\r\n    competenciaMarkersRef.current = [];\r\n    polylineRef.current = []; // Polylines might need tagging too if they persist, but let's clear them via ref for now or tag them\r\n\r\n    clearCompetenciaMarkers();\r\n    clearPolylines();\r\n    setShowingAssociated(false);\r\n    setActiveMercadoPbl(null);\r\n\r\n    markers.forEach(marker => {\r\n      const leafletMarker = createMarkerWithPopup(\r\n        marker,\r\n        markersForMercado || markers,\r\n        'primary'\r\n      );\r\n      if (leafletMarker) {\r\n        map.addLayer(leafletMarker);\r\n        markersRef.current[marker.id] = leafletMarker;\r\n        addGuerraMarker(marker);\r\n      }\r\n    });\r\n\r\n    if (markers.length === 1 && markersRef.current[markers[0].id]) {\r\n      markersRef.current[markers[0].id].openPopup();\r\n    }\r\n\r\n  }, [map, markers, markersForMercado, selectedRegion, clearCompetenciaMarkers, clearPolylines, clearGuerraMarkers, createMarkerWithPopup, addGuerraMarker]);\r\n\r\n\r\n  // --- Efecto para Click en Mapa (Correcci贸n Coordenadas) ---\r\n  useEffect(() => {\r\n    if (!map || !modoCorreccion) return;\r\n\r\n    const handleMapClick = (e) => {\r\n      const { lat, lng } = e.latlng;\r\n      setModoCorreccion(prev => ({ ...prev, lat, lng }));\r\n    };\r\n\r\n    map.on('click', handleMapClick);\r\n    return () => { map.off('click', handleMapClick); };\r\n  }, [map, modoCorreccion]);\r\n\r\n  // --- Efecto para Actualizar Popups cuando cambia modoCorreccion ---\r\n  useEffect(() => {\r\n    if (!map) return;\r\n\r\n    // Iterar sobre los popups abiertos y re-renderizarlos con el nuevo estado\r\n    map.eachLayer(layer => {\r\n      if (layer.getPopup && layer.getPopup() && layer.getPopup().isOpen()) {\r\n        const markerId = Object.keys(markersRef.current).find(key => markersRef.current[key] === layer);\r\n        if (markerId) {\r\n          const marker = markers.find(m => m.id === markerId) || (markersForMercado || []).find(m => m.id === markerId);\r\n          if (marker) {\r\n            const rootDiv = document.getElementById('popup-root-' + marker.id);\r\n            if (rootDiv && rootDiv._reactRoot) {\r\n              rootDiv._reactRoot.render(\r\n                <MapPopup\r\n                  marker={marker}\r\n                  allMarkers={markersForMercado || markers}\r\n                  onShowAssociated={(...args) => showAssociatedIdsRef.current && showAssociatedIdsRef.current(...args)}\r\n                  onActivateCoords={(...args) => handleActivateCoordsRef.current && handleActivateCoordsRef.current(...args)}\r\n                  onSaveCoords={(...args) => handleSaveCoordsRef.current && handleSaveCoordsRef.current(...args)}\r\n                  modoCorreccion={modoCorreccion} // Usamos el valor actual del estado\r\n                  variant={markersForMercado && markersForMercado.includes(marker) ? 'secondary' : 'primary'}\r\n                  nivel2EnNivel1Stations={nivel2EnNivel1Stations} // En el efecto usamos el valor directo porque el efecto depende de 茅l\r\n                  onToggleNivel2EnNivel1={onToggleNivel2EnNivel1}\r\n                />\r\n              );\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }, [modoCorreccion, map, markers, markersForMercado, nivel2EnNivel1Stations, onToggleNivel2EnNivel1]);\r\n\r\n  // Re-render open popups when markers data updates (auto-refresh)\r\n  useEffect(() => {\r\n    if (!map) return;\r\n\r\n    map.eachLayer((layer) => {\r\n      if (layer instanceof L.Marker && layer.getPopup && layer.getPopup()) {\r\n        const popup = layer.getPopup();\r\n        if (popup.isOpen()) {\r\n          const markerData = layer.options.markerData;\r\n          if (markerData && markerData.pbl) {\r\n            // Find updated marker data\r\n            const updatedMarker = markers.find(m => m.pbl === markerData.pbl);\r\n            if (updatedMarker) {\r\n              const rootDiv = popup.getElement()?.querySelector('.popup-root');\r\n              if (rootDiv && rootDiv._reactRoot) {\r\n                // Re-render with updated data\r\n                rootDiv._reactRoot.render(\r\n                  <MapPopup\r\n                    marker={updatedMarker}\r\n                    allMarkers={markersForMercado || markers}\r\n                    onShowAssociated={(...args) => showAssociatedIdsRef.current && showAssociatedIdsRef.current(...args)}\r\n                    onActivateCoords={(...args) => handleActivateCoordsRef.current && handleActivateCoordsRef.current(...args)}\r\n                    onSaveCoords={(...args) => handleSaveCoordsRef.current && handleSaveCoordsRef.current(...args)}\r\n                    modoCorreccion={modoCorreccion}\r\n                    variant={markersForMercado && markersForMercado.includes(updatedMarker) ? 'secondary' : 'primary'}\r\n                    nivel2EnNivel1Stations={nivel2EnNivel1Stations} // En el efecto usamos el valor directo\r\n                    onToggleNivel2EnNivel1={onToggleNivel2EnNivel1}\r\n                  />\r\n                );\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }, [markers, map, markersForMercado, modoCorreccion, nivel2EnNivel1Stations, onToggleNivel2EnNivel1]);\r\n\r\n\r\n  return null;\r\n};\r\n\r\nexport default IconMarkersLayer;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}