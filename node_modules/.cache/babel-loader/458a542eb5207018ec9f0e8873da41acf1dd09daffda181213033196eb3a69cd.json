{"ast":null,"code":"var _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\nimport { useMap } from 'react-leaflet';\nimport L from 'leaflet';\nimport { createCustomIcon, createBrandLogo } from '../utils/iconHelpers';\nimport { getDataBaseComp } from '../services/apiService';\nconst IconMarkersLayer = ({\n  markers,\n  selectedRegion\n}) => {\n  _s();\n  const map = useMap();\n  const markersRef = useRef({});\n  const competenciaMarkersRef = useRef({});\n  const updateInProgressRef = useRef(false);\n  const [baseCompData, setBaseCompData] = useState([]);\n  const [showingCompetencia, setShowingCompetencia] = useState(false);\n  const [currentPbl, setCurrentPbl] = useState(null);\n\n  // Cargar base_comp al montar el componente\n  useEffect(() => {\n    const loadBaseComp = async () => {\n      try {\n        const data = await getDataBaseComp();\n        console.log('‚úÖ Datos crudos recibidos:', data);\n\n        // Asegurar que siempre sea un array\n        let compData = [];\n        if (Array.isArray(data)) {\n          compData = data;\n        } else if (data && data.base_comp && Array.isArray(data.base_comp)) {\n          compData = data.base_comp;\n        } else if (data && data.data && Array.isArray(data.data)) {\n          compData = data.data;\n        } else if (data && typeof data === 'object') {\n          compData = Object.values(data).flat().filter(item => typeof item === 'object');\n        }\n        console.log(`‚úÖ Base competencia cargada: ${compData.length} registros`);\n        setBaseCompData(compData);\n      } catch (error) {\n        console.error('‚ùå Error cargando base_comp:', error);\n        setBaseCompData([]);\n      }\n    };\n    loadBaseComp();\n  }, []);\n\n  // Hacer popup draggable\n  const makeDraggable = useCallback(popup => {\n    if (!map || !popup || !popup._container) return;\n    try {\n      const pos = map.latLngToLayerPoint(popup.getLatLng());\n      L.DomUtil.setPosition(popup._wrapper.parentNode, pos);\n      const draggable = new L.Draggable(popup._container, popup._wrapper);\n      draggable.enable();\n    } catch (error) {\n      console.error('Error making popup draggable:', error);\n    }\n  }, [map]);\n\n  // Limpiar marcadores de competencia\n  const clearCompetenciaMarkers = useCallback(() => {\n    Object.values(competenciaMarkersRef.current).forEach(marker => {\n      try {\n        if (map && map.hasLayer(marker)) {\n          map.removeLayer(marker);\n        }\n      } catch (error) {\n        console.error('Error removiendo marcador competencia:', error);\n      }\n    });\n    competenciaMarkersRef.current = {};\n  }, [map]);\n\n  // Mostrar competencia en el mapa\n  const handleShowCompetencia = useCallback(pbl => {\n    console.log(`üîç Mostrando competencia para PBL: ${pbl}`);\n    console.log(`üìä baseCompData:`, baseCompData, `Tipo: ${typeof baseCompData}`);\n    if (!Array.isArray(baseCompData)) {\n      console.error('‚ùå baseCompData no es un array:', baseCompData);\n      alert('Error: Datos de competencia no disponibles');\n      return;\n    }\n    if (showingCompetencia && currentPbl === pbl) {\n      clearCompetenciaMarkers();\n      setShowingCompetencia(false);\n      setCurrentPbl(null);\n      return;\n    }\n    clearCompetenciaMarkers();\n    const competencia = baseCompData.filter(item => String(item.pbl).trim() === String(pbl).trim());\n    console.log(`üìç Encontrados ${competencia.length} competidores para PBL ${pbl}`);\n    if (competencia.length === 0) {\n      alert('No hay datos de competencia para este PBL');\n      return;\n    }\n\n    // Agregar marcadores de competencia\n    competencia.forEach(comp => {\n      try {\n        const originalMarker = markers.find(m => m.id === comp.id);\n        if (!originalMarker) {\n          console.warn(`No se encontr√≥ marcador original para ID: ${comp.id}`);\n          return;\n        }\n        const compId = `comp-${comp.id}`;\n        const leafletMarker = L.marker([originalMarker.lat, originalMarker.lng], {\n          icon: createCustomIcon(comp.Marca),\n          title: `${comp.Marca} - Competencia`\n        });\n        const popupContent = `\n          <div class=\"popup-container\">\n            <div class=\"popup-header\">\n              <img \n                src=\"${createBrandLogo(comp.Marca)}\"\n                alt=\"${comp.Marca}\"\n                style=\"width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px;\"\n                onerror=\"this.style.display='none'\"\n              />\n              <h3 style=\"margin: 0;\">üè™ ${comp.Marca} (Competencia)</h3>\n            </div>\n            <div class=\"popup-content\">\n              <div class=\"popup-data\">\n                <strong>ID:</strong> ${comp.id}<br />\n                <strong>Marca:</strong> ${comp.Marca}<br />\n                <strong>Direcci√≥n:</strong> ${comp.direccion || '-'}<br />\n              </div>\n              <hr style=\"margin: 10px 0; border: none; border-top: 1px solid #e0e0e0\" />\n              <div class=\"popup-data\">\n                <strong>Precios:</strong><br />\n                G93: ${comp.precio_g93 ? `$${comp.precio_g93}` : 'N/A'}<br />\n                G95: ${comp.precio_g95 ? `$${comp.precio_g95}` : 'N/A'}<br />\n                Diesel: ${comp.precio_diesel ? `$${comp.precio_diesel}` : 'N/A'}<br />\n              </div>\n            </div>\n          </div>\n        `;\n        const popup = L.popup({\n          maxWidth: 350,\n          minWidth: 280,\n          autoClose: false,\n          closeOnClick: false\n        }).setContent(popupContent);\n        leafletMarker.bindPopup(popup);\n        leafletMarker.on('popupopen', () => {\n          makeDraggable(leafletMarker.getPopup());\n        });\n        leafletMarker.on('click', function () {\n          leafletMarker.openPopup();\n        });\n        leafletMarker.addTo(map);\n        competenciaMarkersRef.current[compId] = leafletMarker;\n      } catch (error) {\n        console.error(`Error agregando marcador competencia:`, error);\n      }\n    });\n    setShowingCompetencia(true);\n    setCurrentPbl(pbl);\n  }, [baseCompData, markers, map, clearCompetenciaMarkers, makeDraggable, showingCompetencia, currentPbl]);\n\n  // Limpiar y agregar marcadores\n  const updateMarkers = useCallback(markersToShow => {\n    if (!map || updateInProgressRef.current) return;\n    updateInProgressRef.current = true;\n\n    // Limpiar marcadores anteriores\n    Object.values(markersRef.current).forEach(marker => {\n      try {\n        if (map.hasLayer(marker)) {\n          map.removeLayer(marker);\n        }\n      } catch (error) {\n        console.error('Error removiendo marcador:', error);\n      }\n    });\n    markersRef.current = {};\n\n    // Limpiar competencia al cambiar regi√≥n/filtros\n    clearCompetenciaMarkers();\n    setShowingCompetencia(false);\n    setCurrentPbl(null);\n    console.log(`üìç Agregando ${markersToShow.length} marcadores...`);\n    markersToShow.forEach(marker => {\n      try {\n        const markerId = `${marker.id}-${marker.Marca}`;\n        const uniqueId = `marker-${Date.now()}-${Math.random()}`;\n        if (markersRef.current[markerId]) {\n          return;\n        }\n\n        // Crear marcador\n        const leafletMarker = L.marker([marker.lat, marker.lng], {\n          icon: createCustomIcon(marker.Marca),\n          title: marker.nombre\n        });\n\n        // Contenido del popup\n        const popupContent = `\n          <div class=\"popup-container\">\n            <div class=\"popup-header\">\n              <img \n                src=\"${createBrandLogo(marker.Marca)}\"\n                alt=\"${marker.Marca}\"\n                style=\"width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px;\"\n                onerror=\"this.style.display='none'\"\n              />\n              <h3 style=\"margin: 0;\">${marker.nombre}</h3>\n            </div>\n            <div class=\"popup-content\">\n              <div class=\"popup-data\">\n                <strong>Marca:</strong> ${marker.Marca}<br />\n                <strong>PBL:</strong> ${marker.pbl || '-'}<br />\n                <strong>Region:</strong> ${marker.Region}<br />\n                <strong>Comuna:</strong> ${marker.Comuna}<br />\n                ${marker.direccion ? `<strong>Direcci√≥n:</strong> ${marker.direccion}<br />` : ''}\n                ${marker.eds ? `<strong>EDS:</strong> ${marker.eds}<br />` : ''}\n              </div>\n              <hr style=\"margin: 10px 0; border: none; border-top: 1px solid #e0e0e0\" />\n              <div class=\"popup-data\">\n                <strong>Precios:</strong><br />\n                G93: ${marker.precio_g93 ? `$${marker.precio_g93}` : 'N/A'}<br />\n                G95: ${marker.precio_g95 ? `$${marker.precio_g95}` : 'N/A'}<br />\n                Diesel: ${marker.precio_diesel ? `$${marker.precio_diesel}` : 'N/A'}<br />\n              </div>\n              ${marker.Guerra_Precio === 'Si' ? `\n                <hr style=\"margin: 10px 0; border: none; border-top: 1px solid #e0e0e0\" />\n                <div class=\"popup-data\" style=\"color: #d32f2f; font-weight: bold;\">\n                  ‚ö†Ô∏è Guerra de Precio Activa\n                </div>\n              ` : ''}\n              <hr style=\"margin: 10px 0; border: none; border-top: 1px solid #e0e0e0\" />\n              <div id=\"competencia-${uniqueId}\"></div>\n            </div>\n          </div>\n        `;\n        const popup = L.popup({\n          maxWidth: 400,\n          minWidth: 300,\n          autoClose: false,\n          closeOnClick: false\n        }).setContent(popupContent);\n        leafletMarker.bindPopup(popup);\n\n        // Hacer draggable al abrir\n        leafletMarker.on('popupopen', () => {\n          makeDraggable(leafletMarker.getPopup());\n          setTimeout(() => {\n            const container = document.getElementById(`competencia-${uniqueId}`);\n            if (container && marker.pbl) {\n              container.innerHTML = `\n                <button class=\"btn-competencia\" onclick=\"window.handleShowCompetencia && window.handleShowCompetencia('${marker.pbl}')\">\n                  üîç Ver Competencia\n                </button>\n              `;\n            }\n          }, 200);\n        });\n        leafletMarker.on('click', function () {\n          leafletMarker.openPopup();\n        });\n        leafletMarker.addTo(map);\n        markersRef.current[markerId] = leafletMarker;\n      } catch (error) {\n        console.error(`Error agregando marcador:`, error);\n      }\n    });\n    updateInProgressRef.current = false;\n  }, [map, clearCompetenciaMarkers, makeDraggable]);\n\n  // Actualizar cuando cambian los marcadores\n  useEffect(() => {\n    if (!map || !markers || markers.length === 0) {\n      Object.values(markersRef.current).forEach(marker => {\n        try {\n          if (map.hasLayer(marker)) {\n            map.removeLayer(marker);\n          }\n        } catch (error) {\n          console.error('Error removiendo marcador:', error);\n        }\n      });\n      markersRef.current = {};\n      clearCompetenciaMarkers();\n      return;\n    }\n    console.log(`‚úÖ Actualizando ${markers.length} marcadores para regi√≥n: ${selectedRegion}`);\n    updateMarkers(markers);\n  }, [markers, selectedRegion, map, updateMarkers, clearCompetenciaMarkers]);\n\n  // Exponer funci√≥n globalmente para que el HTML pueda acceder\n  useEffect(() => {\n    window.handleShowCompetencia = handleShowCompetencia;\n    return () => {\n      delete window.handleShowCompetencia;\n    };\n  }, [handleShowCompetencia]);\n  return null;\n};\n_s(IconMarkersLayer, \"RJKOuzi6DYNsY1gYOAlrVfSiZqM=\", false, function () {\n  return [useMap];\n});\n_c = IconMarkersLayer;\nexport default IconMarkersLayer;\nvar _c;\n$RefreshReg$(_c, \"IconMarkersLayer\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useCallback","useMap","L","createCustomIcon","createBrandLogo","getDataBaseComp","IconMarkersLayer","markers","selectedRegion","_s","map","markersRef","competenciaMarkersRef","updateInProgressRef","baseCompData","setBaseCompData","showingCompetencia","setShowingCompetencia","currentPbl","setCurrentPbl","loadBaseComp","data","console","log","compData","Array","isArray","base_comp","Object","values","flat","filter","item","length","error","makeDraggable","popup","_container","pos","latLngToLayerPoint","getLatLng","DomUtil","setPosition","_wrapper","parentNode","draggable","Draggable","enable","clearCompetenciaMarkers","current","forEach","marker","hasLayer","removeLayer","handleShowCompetencia","pbl","alert","competencia","String","trim","comp","originalMarker","find","m","id","warn","compId","leafletMarker","lat","lng","icon","Marca","title","popupContent","direccion","precio_g93","precio_g95","precio_diesel","maxWidth","minWidth","autoClose","closeOnClick","setContent","bindPopup","on","getPopup","openPopup","addTo","updateMarkers","markersToShow","markerId","uniqueId","Date","now","Math","random","nombre","Region","Comuna","eds","Guerra_Precio","setTimeout","container","document","getElementById","innerHTML","window","_c","$RefreshReg$"],"sources":["C:/Users/e08f/Desktop/Proyectos/Resumen/mapa-v2/src/components/IconMarkersLayer.jsx"],"sourcesContent":["import React, { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { useMap } from 'react-leaflet';\r\nimport L from 'leaflet';\r\nimport { createCustomIcon, createBrandLogo } from '../utils/iconHelpers';\r\nimport { getDataBaseComp } from '../services/apiService';\r\n\r\nconst IconMarkersLayer = ({ markers, selectedRegion }) => {\r\n  const map = useMap();\r\n  const markersRef = useRef({});\r\n  const competenciaMarkersRef = useRef({});\r\n  const updateInProgressRef = useRef(false);\r\n  const [baseCompData, setBaseCompData] = useState([]);\r\n  const [showingCompetencia, setShowingCompetencia] = useState(false);\r\n  const [currentPbl, setCurrentPbl] = useState(null);\r\n\r\n  // Cargar base_comp al montar el componente\r\n  useEffect(() => {\r\n    const loadBaseComp = async () => {\r\n      try {\r\n        const data = await getDataBaseComp();\r\n        console.log('‚úÖ Datos crudos recibidos:', data);\r\n        \r\n        // Asegurar que siempre sea un array\r\n        let compData = [];\r\n        if (Array.isArray(data)) {\r\n          compData = data;\r\n        } else if (data && data.base_comp && Array.isArray(data.base_comp)) {\r\n          compData = data.base_comp;\r\n        } else if (data && data.data && Array.isArray(data.data)) {\r\n          compData = data.data;\r\n        } else if (data && typeof data === 'object') {\r\n          compData = Object.values(data).flat().filter(item => typeof item === 'object');\r\n        }\r\n        \r\n        console.log(`‚úÖ Base competencia cargada: ${compData.length} registros`);\r\n        setBaseCompData(compData);\r\n      } catch (error) {\r\n        console.error('‚ùå Error cargando base_comp:', error);\r\n        setBaseCompData([]);\r\n      }\r\n    };\r\n    loadBaseComp();\r\n  }, []);\r\n\r\n  // Hacer popup draggable\r\n  const makeDraggable = useCallback((popup) => {\r\n    if (!map || !popup || !popup._container) return;\r\n\r\n    try {\r\n      const pos = map.latLngToLayerPoint(popup.getLatLng());\r\n      L.DomUtil.setPosition(popup._wrapper.parentNode, pos);\r\n      \r\n      const draggable = new L.Draggable(popup._container, popup._wrapper);\r\n      draggable.enable();\r\n    } catch (error) {\r\n      console.error('Error making popup draggable:', error);\r\n    }\r\n  }, [map]);\r\n\r\n  // Limpiar marcadores de competencia\r\n  const clearCompetenciaMarkers = useCallback(() => {\r\n    Object.values(competenciaMarkersRef.current).forEach(marker => {\r\n      try {\r\n        if (map && map.hasLayer(marker)) {\r\n          map.removeLayer(marker);\r\n        }\r\n      } catch (error) {\r\n        console.error('Error removiendo marcador competencia:', error);\r\n      }\r\n    });\r\n    competenciaMarkersRef.current = {};\r\n  }, [map]);\r\n\r\n  // Mostrar competencia en el mapa\r\n  const handleShowCompetencia = useCallback((pbl) => {\r\n    console.log(`üîç Mostrando competencia para PBL: ${pbl}`);\r\n    console.log(`üìä baseCompData:`, baseCompData, `Tipo: ${typeof baseCompData}`);\r\n    \r\n    if (!Array.isArray(baseCompData)) {\r\n      console.error('‚ùå baseCompData no es un array:', baseCompData);\r\n      alert('Error: Datos de competencia no disponibles');\r\n      return;\r\n    }\r\n\r\n    if (showingCompetencia && currentPbl === pbl) {\r\n      clearCompetenciaMarkers();\r\n      setShowingCompetencia(false);\r\n      setCurrentPbl(null);\r\n      return;\r\n    }\r\n\r\n    clearCompetenciaMarkers();\r\n\r\n    const competencia = baseCompData.filter(item => \r\n      String(item.pbl).trim() === String(pbl).trim()\r\n    );\r\n\r\n    console.log(`üìç Encontrados ${competencia.length} competidores para PBL ${pbl}`);\r\n\r\n    if (competencia.length === 0) {\r\n      alert('No hay datos de competencia para este PBL');\r\n      return;\r\n    }\r\n\r\n    // Agregar marcadores de competencia\r\n    competencia.forEach((comp) => {\r\n      try {\r\n        const originalMarker = markers.find(m => m.id === comp.id);\r\n        \r\n        if (!originalMarker) {\r\n          console.warn(`No se encontr√≥ marcador original para ID: ${comp.id}`);\r\n          return;\r\n        }\r\n\r\n        const compId = `comp-${comp.id}`;\r\n\r\n        const leafletMarker = L.marker([originalMarker.lat, originalMarker.lng], {\r\n          icon: createCustomIcon(comp.Marca),\r\n          title: `${comp.Marca} - Competencia`\r\n        });\r\n\r\n        const popupContent = `\r\n          <div class=\"popup-container\">\r\n            <div class=\"popup-header\">\r\n              <img \r\n                src=\"${createBrandLogo(comp.Marca)}\"\r\n                alt=\"${comp.Marca}\"\r\n                style=\"width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px;\"\r\n                onerror=\"this.style.display='none'\"\r\n              />\r\n              <h3 style=\"margin: 0;\">üè™ ${comp.Marca} (Competencia)</h3>\r\n            </div>\r\n            <div class=\"popup-content\">\r\n              <div class=\"popup-data\">\r\n                <strong>ID:</strong> ${comp.id}<br />\r\n                <strong>Marca:</strong> ${comp.Marca}<br />\r\n                <strong>Direcci√≥n:</strong> ${comp.direccion || '-'}<br />\r\n              </div>\r\n              <hr style=\"margin: 10px 0; border: none; border-top: 1px solid #e0e0e0\" />\r\n              <div class=\"popup-data\">\r\n                <strong>Precios:</strong><br />\r\n                G93: ${comp.precio_g93 ? `$${comp.precio_g93}` : 'N/A'}<br />\r\n                G95: ${comp.precio_g95 ? `$${comp.precio_g95}` : 'N/A'}<br />\r\n                Diesel: ${comp.precio_diesel ? `$${comp.precio_diesel}` : 'N/A'}<br />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        `;\r\n\r\n        const popup = L.popup({\r\n          maxWidth: 350,\r\n          minWidth: 280,\r\n          autoClose: false,\r\n          closeOnClick: false\r\n        }).setContent(popupContent);\r\n\r\n        leafletMarker.bindPopup(popup);\r\n\r\n        leafletMarker.on('popupopen', () => {\r\n          makeDraggable(leafletMarker.getPopup());\r\n        });\r\n\r\n        leafletMarker.on('click', function() {\r\n          leafletMarker.openPopup();\r\n        });\r\n\r\n        leafletMarker.addTo(map);\r\n        competenciaMarkersRef.current[compId] = leafletMarker;\r\n\r\n      } catch (error) {\r\n        console.error(`Error agregando marcador competencia:`, error);\r\n      }\r\n    });\r\n\r\n    setShowingCompetencia(true);\r\n    setCurrentPbl(pbl);\r\n  }, [baseCompData, markers, map, clearCompetenciaMarkers, makeDraggable, showingCompetencia, currentPbl]);\r\n\r\n  // Limpiar y agregar marcadores\r\n  const updateMarkers = useCallback((markersToShow) => {\r\n    if (!map || updateInProgressRef.current) return;\r\n\r\n    updateInProgressRef.current = true;\r\n\r\n    // Limpiar marcadores anteriores\r\n    Object.values(markersRef.current).forEach(marker => {\r\n      try {\r\n        if (map.hasLayer(marker)) {\r\n          map.removeLayer(marker);\r\n        }\r\n      } catch (error) {\r\n        console.error('Error removiendo marcador:', error);\r\n      }\r\n    });\r\n    markersRef.current = {};\r\n\r\n    // Limpiar competencia al cambiar regi√≥n/filtros\r\n    clearCompetenciaMarkers();\r\n    setShowingCompetencia(false);\r\n    setCurrentPbl(null);\r\n\r\n    console.log(`üìç Agregando ${markersToShow.length} marcadores...`);\r\n\r\n    markersToShow.forEach((marker) => {\r\n      try {\r\n        const markerId = `${marker.id}-${marker.Marca}`;\r\n        const uniqueId = `marker-${Date.now()}-${Math.random()}`;\r\n\r\n        if (markersRef.current[markerId]) {\r\n          return;\r\n        }\r\n\r\n        // Crear marcador\r\n        const leafletMarker = L.marker([marker.lat, marker.lng], {\r\n          icon: createCustomIcon(marker.Marca),\r\n          title: marker.nombre\r\n        });\r\n\r\n        // Contenido del popup\r\n        const popupContent = `\r\n          <div class=\"popup-container\">\r\n            <div class=\"popup-header\">\r\n              <img \r\n                src=\"${createBrandLogo(marker.Marca)}\"\r\n                alt=\"${marker.Marca}\"\r\n                style=\"width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px;\"\r\n                onerror=\"this.style.display='none'\"\r\n              />\r\n              <h3 style=\"margin: 0;\">${marker.nombre}</h3>\r\n            </div>\r\n            <div class=\"popup-content\">\r\n              <div class=\"popup-data\">\r\n                <strong>Marca:</strong> ${marker.Marca}<br />\r\n                <strong>PBL:</strong> ${marker.pbl || '-'}<br />\r\n                <strong>Region:</strong> ${marker.Region}<br />\r\n                <strong>Comuna:</strong> ${marker.Comuna}<br />\r\n                ${marker.direccion ? `<strong>Direcci√≥n:</strong> ${marker.direccion}<br />` : ''}\r\n                ${marker.eds ? `<strong>EDS:</strong> ${marker.eds}<br />` : ''}\r\n              </div>\r\n              <hr style=\"margin: 10px 0; border: none; border-top: 1px solid #e0e0e0\" />\r\n              <div class=\"popup-data\">\r\n                <strong>Precios:</strong><br />\r\n                G93: ${marker.precio_g93 ? `$${marker.precio_g93}` : 'N/A'}<br />\r\n                G95: ${marker.precio_g95 ? `$${marker.precio_g95}` : 'N/A'}<br />\r\n                Diesel: ${marker.precio_diesel ? `$${marker.precio_diesel}` : 'N/A'}<br />\r\n              </div>\r\n              ${marker.Guerra_Precio === 'Si' ? `\r\n                <hr style=\"margin: 10px 0; border: none; border-top: 1px solid #e0e0e0\" />\r\n                <div class=\"popup-data\" style=\"color: #d32f2f; font-weight: bold;\">\r\n                  ‚ö†Ô∏è Guerra de Precio Activa\r\n                </div>\r\n              ` : ''}\r\n              <hr style=\"margin: 10px 0; border: none; border-top: 1px solid #e0e0e0\" />\r\n              <div id=\"competencia-${uniqueId}\"></div>\r\n            </div>\r\n          </div>\r\n        `;\r\n\r\n        const popup = L.popup({\r\n          maxWidth: 400,\r\n          minWidth: 300,\r\n          autoClose: false,\r\n          closeOnClick: false\r\n        }).setContent(popupContent);\r\n\r\n        leafletMarker.bindPopup(popup);\r\n\r\n        // Hacer draggable al abrir\r\n        leafletMarker.on('popupopen', () => {\r\n          makeDraggable(leafletMarker.getPopup());\r\n          \r\n          setTimeout(() => {\r\n            const container = document.getElementById(`competencia-${uniqueId}`);\r\n            if (container && marker.pbl) {\r\n              container.innerHTML = `\r\n                <button class=\"btn-competencia\" onclick=\"window.handleShowCompetencia && window.handleShowCompetencia('${marker.pbl}')\">\r\n                  üîç Ver Competencia\r\n                </button>\r\n              `;\r\n            }\r\n          }, 200);\r\n        });\r\n\r\n        leafletMarker.on('click', function() {\r\n          leafletMarker.openPopup();\r\n        });\r\n\r\n        leafletMarker.addTo(map);\r\n        markersRef.current[markerId] = leafletMarker;\r\n\r\n      } catch (error) {\r\n        console.error(`Error agregando marcador:`, error);\r\n      }\r\n    });\r\n\r\n    updateInProgressRef.current = false;\r\n  }, [map, clearCompetenciaMarkers, makeDraggable]);\r\n\r\n  // Actualizar cuando cambian los marcadores\r\n  useEffect(() => {\r\n    if (!map || !markers || markers.length === 0) {\r\n      Object.values(markersRef.current).forEach(marker => {\r\n        try {\r\n          if (map.hasLayer(marker)) {\r\n            map.removeLayer(marker);\r\n          }\r\n        } catch (error) {\r\n          console.error('Error removiendo marcador:', error);\r\n        }\r\n      });\r\n      markersRef.current = {};\r\n      clearCompetenciaMarkers();\r\n      return;\r\n    }\r\n\r\n    console.log(`‚úÖ Actualizando ${markers.length} marcadores para regi√≥n: ${selectedRegion}`);\r\n    updateMarkers(markers);\r\n\r\n  }, [markers, selectedRegion, map, updateMarkers, clearCompetenciaMarkers]);\r\n\r\n  // Exponer funci√≥n globalmente para que el HTML pueda acceder\r\n  useEffect(() => {\r\n    window.handleShowCompetencia = handleShowCompetencia;\r\n    return () => {\r\n      delete window.handleShowCompetencia;\r\n    };\r\n  }, [handleShowCompetencia]);\r\n\r\n  return null;\r\n};\r\n\r\nexport default IconMarkersLayer;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}